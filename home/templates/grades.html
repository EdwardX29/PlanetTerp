{% extends "base_main.html" %}
{% load crispy_forms_tags %}

{% block title %}Grade Lookup | PlanetTerp{% endblock %}

{% block head %}

<meta property="og:title" content="Grade Lookup | PlanetTerp">
<meta name="description" content="Grade data by professor, course, semester, and/or section at the University of Maryland &mdash; College Park." />
<meta property="og:type" content="website">
<meta property="og:image" content="https://planetterp.com/static/images/grades.png">
<meta property="og:image:alt" content="A screenshot of a bar chart entitled &quot;CMSC131 Spring 2017 Section 0101 Grade Distribution&quot;. The average GPA was 2.30 between 32 students. The most common grade was an A.">
<meta property="og:url" content="https://planetterp.com/grades">

<style>
	.error-alert {
		width: 35%;
	}

	.graph-wrapper {
		width: 600px;
		height: 400px;

		margin: 0 auto;
		margin-bottom: 30px
	}

	.grades-info {
		margin-bottom: 0px;
	}

	/** Begin mobile **/

	@media (max-width: 800px) {
		.graph-wrapper {
			width: 90vw;
			height: 300px;
		}
	}

	/** End mobile **/
</style>
{% endblock %}


{% block content %}
<div class="info-page">
	<h1 class="text-center">Historical Grade Lookup</h1>

	<div class="row">
		<div class="col-6 text-center">
			<h2>Lookup by course</h2>
			<div id="course-lookup-form-container">
				{% crispy form %}
			</div>
		</div>

		<div class="col-6 text-center">
			<h2>Lookup by professor</h2>

			<div class="form-group row justify-content-center">
				<label for="professor-search" class="col-form-label">Professor</label>
				<div class="col-sm-5">
					<input type="text" class="form-control autocomplete" id="professor-search" placeholder="Search for a professor..." name="professor">
				</div>
			</div>
		</div>
	</div>

	<div id="include-spring2020-input" style="text-align: center; display: none;">
		<label>
			Include Spring 2020
			<input type="checkbox" id="include-spring2020" style="top: 2px; position: relative;">
		</label>
	</div>

	<p id="grades-information" class="text-center" style="margin-bottom: 0;"></p>
	<div id="grades-graphs"></div>
</div>

<hr>

<div class="info-page">
	<p>Data is not guaranteed to be correct.</p>

	<p>"W"s are considered to be 0.0 quality points. "Other" grades are not factored into GPA calculation.</p>

	<p><em>The source of the grade data can be found <a href="/about#credits">here</a>.</em></p>
</div>

<script type="text/javascript" src="../static/js/chart.min.js"></script>
<script>
	const ENTER_KEY = 13;
	var canvasCount = 0;
	var gradesGraph;
	var lastSearch;

	$(function() {
		initializeCourseSearchAutoComplete();

		// Allow course search when user presses the enter key
		$("#course-search").keypress(function (e) {
			if (e.which == ENTER_KEY) {
				// TODO Figure out why pressing enter twice causes the event to
				// handle the ajax request, despite explicity telling it not to
				// via preventDefault().
				submitCourseSearch();
				e.preventDefault();
			}
		});

		// Allow professor search when user presses the enter key
		$("#professor-search").keypress(function (e) {
			$("#semester-search-input").hide();
			$("#section-search-input").hide();

			if (e.which == ENTER_KEY) {
				professorGrades($("#professor-search").val());
			}
		});

		$('#include-spring2020').on('change', function() {
			if (lastSearch == "course") {
				submitCourseSearch();
			} else if (lastSearch == "professor") {
				professorGrades($("#professor-search").val());
			}
		});

		function professorGrades(professor) {
			lastSearch = "professor";

			$.ajax({
				url: "{% url 'grades' %}",
				type: "POST",
				dataType: 'json',
				data: {
					'professor': professor,
					'professor_courses': true,
					'spring_2020': $('#include-spring2020').is(':checked')
				},
				success: function(data) {
					$("#grades-information").html("");
					$("#grades-information-error").html("");
					$("html").find('.graph-wrapper').remove(); // Remove all previously created graphs
					$("html").find('.grades-info').remove(); // Remove all previously created course information

					var name = $("#professor-search").val();
					var averageGpa = data.average_gpa;
					var numStudents = data.num_students;
					var slug = data.professor_slug;

					$("#grades-information").html(`<h1><strong><a href="/professor/${slug}" target="_blank"> ${name} </a></strong></h1> <h4>Average GPA: ${averageGpa.toFixed(2)} between ${numStudents} students</h4>`);
					$("#grades-information").append(`<em> ${name} grade distribution for ${Object.keys(data.data).length} course(s):</em>`);

					for (const [course_name, course_data] of Object.entries(data.data)) {
						generate_graph(course_name, course_data);
					}

					$("#include-spring2020-input").show();
				},
				error: function(response) {
					$("html").find('.graph-wrapper').remove(); // Remove all previously created graphs
					$("html").find('.grades-info').remove(); // Remove all previously created course information

					if (response.responseText == "Only Spring 2020 grade data is available for those parameters.") {
						$("#include-spring2020-input").show();

						var errorText = `<div class="alert alert-info error-alert text-center">`;
						errorText += "<strong>Note:</strong> ";
						errorText += "This professor only has grade data for Spring 2020. Click on the <code>include spring 2020</code> checkbox above to check the grades for this professor for Spring 2020.</h5>";
						errorText += "</div><br />";
						}
					else {
						var errorText = `<div class="alert alert-danger error-alert text-center">`;
						errorText += "<strong>Error:</strong> ";
						errorText += "No grade data available for that professor.";
						errorText += "</div><br />";
					}
					$("#grades-information").html("");
					$("#grades-information-error").html(errorText);
				}
			})
		}

		$("#professor-search").autocomplete({
			minLength: 3,
			source: function(request, response) {
				$.ajax({
					url: "{% url 'autocomplete' %}",
					dataType: 'json',
					data: {
						"query": request.term,
						"types[]": ["professor"],
						"return_attrs[]": ["name"]
					},
					success: function(data) {
						response(data);
					}
				})
			},
			select: function(event, ui) {
				var professor = ui.item.result.name;
				professorGrades(professor);
			}
		});
	});

	function getCourseSearchParams() {
		var course = $("#course-search").val();
		var semester = $("#semester-search").val();
		var section = $("#section-search").val();
		return {
			course: course,
			semester: semester,
			section: section
		}
	}

	function initializeCourseSearchAutoComplete() {
		$("#course-search").autocomplete({
			minLength: 3,
			source: function(request, response) {
				$.ajax({
					url: "{% url 'autocomplete' %}",
					dataType: 'json',
					data: {
						"query": request.term,
						"types[]": ["course"],
						"return_attrs[]": ["name"]
					},
					success: function(data) {
						response(data);
					}
				})
			},
			select: function(e, ui) {
				$("#course-search").val(ui.item.result.name);
				submitCourseSearch();
				e.preventDefault();
			}
		});
	}

	function generate_graph(course, semester, section, grade_data) {
		course = course.toUpperCase();
		$("#grades-graphs").append('<p id="grades-text' + canvasCount + '" class="text-center grades-info"></p>')
		$("#grades-graphs").append('<div class="graph-wrapper"><canvas id="grades' + canvasCount + '" width="500px" height="500px" style="margin: 0 auto;"></canvas></div>')

		var graph = document.getElementById('grades' + canvasCount).getContext("2d");
		var grades_text = `Showing data for <a href="/course/${course}" target="_blank">${course}</a>`

		if ($("#semester-search").is(':visible')) {
			grades_text += ` ${semester}`
		}
		if ($("#section-search").is(':visible') && $("#section-search").val()) {
			grades_text += ` (Section ${section})`
		}

		grades_text += `<br>Average GPA: ${grade_data.average_gpa.toFixed(2)} between ${grade_data.num_students} students`
		$("#grades-text" + canvasCount).html(grades_text);
		canvasCount++;

		gradesGraph = new Chart(graph, {
			type: 'bar',
			data: {
				labels: ["A", "B", "C", "D", "F", "W", "other"],
				datasets: [
					{
						label: "-",
						data: grade_data.data_minus,
						backgroundColor: [
							'rgba(58, 215, 65, .4)',
							'rgba(58, 215, 65, .4)',
							'rgba(58, 215, 65, .4)',
							'rgba(58, 215, 65, .4)'
						],
						borderColor: [
							'rgba(29, 77, 0, 1)',
							'rgba(29, 77, 0, 1)',
							'rgba(29, 77, 0, 1)',
							'rgba(29, 77, 0, 1)'
						],
						borderWidth: 2
					},
					{
						label: "",
						data: grade_data.data_flat,
						backgroundColor: [
							'rgba(25, 140, 35, .5)',
							'rgba(25, 140, 35, .5)',
							'rgba(25, 140, 35, .5)',
							'rgba(25, 140, 35, .5)',
							'rgba(226, 0, 0, .7)',
							'rgba(226, 0, 0, .7)',
							'rgba(217, 217, 217, .4)',
						],
						borderColor: [
							'rgba(29, 77, 0, 1)',
							'rgba(29, 77, 0, 1)',
							'rgba(29, 77, 0, 1)',
							'rgba(29, 77, 0, 1)',
							'rgba(196, 0, 0, 1)',
							'rgba(196, 0, 0, 1)',
							'rgba(201, 201, 201, 1)'
						],
						borderWidth: 2
					},
					{
						label: "+",
						data: grade_data.data_plus,
						backgroundColor: [
							'rgba(6, 74, 12, .7)',
							'rgba(6, 74, 12, .7)',
							'rgba(6, 74, 12, .7)',
							'rgba(6, 74, 12, .7)'
						],
						borderColor: [
							'rgba(29, 77, 0, 1)',
							'rgba(29, 77, 0, 1)',
							'rgba(29, 77, 0, 1)',
							'rgba(29, 77, 0, 1)'
						],
						borderWidth: 2
					}
				]
			},
			options: {
				title: {
					display: true,
					text: 'Grade Distribution'
				},
				scales: {
					xAxes: [{stacked: true}],
					yAxes: [{
						stacked: true,
						scaleLabel: {
							display: true,
							labelString: "% of students"
						}}
					]
				},
				legend: {
					reverse: true
				},
				responsive: true,
				maintainAspectRatio: false,
				tooltips: {
					callbacks: {
						title: function(tooltipItem, data) {
							return tooltipItem[0]['xLabel'] + data['datasets'][tooltipItem[0]['datasetIndex']]['label'];
						}
					}
				}
			}
		});
	}

	function submitCourseSearch() {
		lastSearch = "course";
		var params = getCourseSearchParams();
		var course = params.course;
		var semester = params.semester;
		var section = params.section;

		$.ajax({
			url: "{% url 'grades' %}",
			type: "POST",
			dataType: 'json',
			data: {
				'course': course,
				'semester': semester,
				'section': section,
				'spring_2020': $('#include-spring2020').is(':checked')
			},
			success: function(data) {
				$("html").find('.graph-wrapper').remove(); // Remove all previously created graphs
				$("html").find('.grades-info').remove(); // Remove all previously created course information
				$("#grades-information").html("");
				$("#course-lookup-form-container").html(data.form);
				initializeCourseSearchAutoComplete();

				if (data["success"]) {
					$(".lookup-error").hide();
					$("#semester-search-input").show();
					$("#semester-search").prop('checked', false);
					// TODO Don't show Spring 2020 option if selected course
					// doesn't have spring 2020 data
					$("#include-spring2020-input").show();
					if (semester) {
						var course_department = semester.split(" ")[0];
						var course_number = semester.split(" ")[1];
						if (!(course_department == "Spring" || Number(course_number) >= 2020)) {
							$("#include-spring2020-input").hide();
						}
					}

					if ($("#semester-search").val()) {
						$("#section-search-input").show();
					}

					generate_graph(course, semester, section, data.data);
				} else {
					$(".lookup-error").show();
				}
			}
		})
	}
</script>
{% endblock %}
